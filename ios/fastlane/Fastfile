# Fastfile - シューマイ iOS アプリのリリース自動化
#
# 使用方法:
#   fastlane beta        - TestFlightにアップロード
#   fastlane release     - App Storeにアップロード
#   fastlane screenshots - Maestroでスクリーンショットを自動生成
#   fastlane build       - ビルドのみ
#   fastlane upload      - 既存IPAをアップロード

default_platform(:ios)

# App Store Connect API キー設定
API_KEY = app_store_connect_api_key(
  key_id: "9WWS63UF8R",
  issuer_id: "77deb994-187e-4739-abd4-cdc905295fe6",
  key_filepath: "./fastlane/AuthKey_9WWS63UF8R.p8"
)

platform :ios do

  desc "MaestroでiPhoneスクリーンショットを自動生成（事前にiPhoneシミュレーターを起動しておく）"
  lane :screenshots_iphone do
    # 起動中のiPhoneシミュレーターのUDIDを取得
    device_udid = `xcrun simctl list devices booted | grep iPhone | grep -oE '\\([0-9A-Fa-f-]+\\)' | tr -d '()' | head -1`.strip
    UI.user_error!("iPhoneシミュレーターが起動していません") if device_udid.empty?
    UI.message("対象デバイス: #{device_udid}")

    UI.message("サンプルデータを配置中...")
    sh("cd ../.. && ./scripts/setup_sample_data.sh #{device_udid}")

    UI.message("iPhoneスクリーンショットを撮影中...")
    sh("cd ../.. && ~/.maestro/bin/maestro --device #{device_udid} test .maestro/screenshots_iphone.yaml")

    UI.success("スクリーンショットが ios/fastlane/screenshots/ja/iPhone 16 Pro Max-*.png に保存されました")
  end

  desc "MaestroでiPadスクリーンショットを自動生成（事前にiPadシミュレーターを起動しておく）"
  lane :screenshots_ipad do
    # 起動中のiPadシミュレーターのUDIDを取得
    device_udid = `xcrun simctl list devices booted | grep iPad | grep -oE '\\([0-9A-Fa-f-]+\\)' | tr -d '()' | head -1`.strip
    UI.user_error!("iPadシミュレーターが起動していません") if device_udid.empty?
    UI.message("対象デバイス: #{device_udid}")

    UI.message("サンプルデータを配置中...")
    sh("cd ../.. && ./scripts/setup_sample_data.sh #{device_udid}")

    UI.message("iPadスクリーンショットを撮影中...")
    sh("cd ../.. && ~/.maestro/bin/maestro --device #{device_udid} test .maestro/screenshots_ipad.yaml")

    UI.success("スクリーンショットが ios/fastlane/screenshots/ja/iPad Pro 13-inch (M4)-*.png に保存されました")
  end

  desc "TestFlightにベータ版をアップロード"
  lane :beta do
    # ビルド番号を自動インクリメント
    increment_build_number(xcodeproj: "Runner.xcodeproj")

    # アプリをビルド
    build_app(
      workspace: "Runner.xcworkspace",
      scheme: "Runner",
      export_method: "app-store",
      output_directory: "./build",
      output_name: "shuumy.ipa"
    )

    # TestFlightにアップロード
    upload_to_testflight(
      api_key: API_KEY,
      skip_waiting_for_build_processing: true
    )
  end

  desc "App Storeに本番リリース"
  lane :release do
    # ビルド番号を自動インクリメント
    increment_build_number(xcodeproj: "Runner.xcodeproj")

    # アプリをビルド
    build_app(
      workspace: "Runner.xcworkspace",
      scheme: "Runner",
      export_method: "app-store",
      output_directory: "./build",
      output_name: "shuumy.ipa"
    )

    # App Store Connectにアップロード
    upload_to_app_store(
      api_key: API_KEY,
      skip_metadata: false,
      skip_screenshots: true,  # スクリーンショットは別途管理
      submit_for_review: false,  # 自動審査提出はオフ（手動確認後に提出）
      force: true,  # HTMLレポートのスキップ
      precheck_include_in_app_purchases: false  # APIキーではIAPのチェック不可
    )
  end

  desc "ビルドのみ（アップロードなし）"
  lane :build do
    build_app(
      workspace: "Runner.xcworkspace",
      scheme: "Runner",
      export_method: "app-store",
      output_directory: "./build",
      output_name: "shuumy.ipa"
    )
  end

  desc "メタデータのみアップロード（ビルドなし）"
  lane :metadata do
    upload_to_app_store(
      api_key: API_KEY,
      skip_binary_upload: true,
      skip_screenshots: true,
      force: true
    )
  end

  desc "スクリーンショットのみアップロード"
  lane :upload_screenshots do
    upload_to_app_store(
      api_key: API_KEY,
      skip_binary_upload: true,
      skip_metadata: true,
      overwrite_screenshots: true,
      force: true,
      precheck_include_in_app_purchases: false
    )
  end

  desc "既存のIPAをアップロード（ビルド済みの場合）"
  lane :upload do
    upload_to_app_store(
      api_key: API_KEY,
      ipa: "./build/shuumy.ipa",
      skip_metadata: false,
      skip_screenshots: true,
      submit_for_review: false,
      force: true,
      precheck_include_in_app_purchases: false  # APIキーではIAPのチェック不可
    )
  end

end
